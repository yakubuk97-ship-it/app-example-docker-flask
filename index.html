<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MyPersonalBuyer</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:16px}
    button{padding:10px 14px;border:0;border-radius:10px;cursor:pointer}
    .row{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
    #hello{margin:10px 0 4px;font-weight:600}
    pre{white-space:pre-wrap;background:#f6f7f8;padding:8px;border-radius:8px}
  </style>
</head>
<body>
  <h2>MyPersonalBuyer</h2>
  <div id="hello">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è‚Ä¶</div>
  <div class="row">
    <button id="pingBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å /api/ping</button>
    <button id="closeBtn">–ó–∞–∫—Ä—ã—Ç—å WebApp</button>
  </div>
  <pre id="log"></pre>

<script>
const tg = window.Telegram?.WebApp;
const $ = id => document.getElementById(id);
const log = m => $("log").textContent = typeof m === "string" ? m : JSON.stringify(m, null, 2);

if (tg){ tg.ready(); tg.expand(); }

(async () => {
  try {
    const init_data = tg?.initData || "";            // –í–ê–ñ–ù–û: —Å—Ç—Ä–æ–∫–∞ initData
    const r = await fetch("/api/auth", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ init_data })
    });
    const j = await r.json();
    if (j.ok){
      const u = j.user || {};
      $("hello").textContent = `–ü—Ä–∏–≤–µ—Ç, ${u.first_name || u.username || "–¥—Ä—É–≥"} üëã`;
      log({ok:true, user:u});
    } else {
      $("hello").textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è üòï";
      log(j);
    }
  } catch(e){
    $("hello").textContent = "–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ üòï";
    log(String(e));
  }
})();

$("pingBtn").onclick = async () => {
  const r = await fetch("/api/ping"); log(await r.json());
};
$("closeBtn").onclick = () => { if (tg?.close) tg.close(); };
</script>
</body>
</html>
