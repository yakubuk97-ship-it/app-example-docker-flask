<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MyPersonalBuyer</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; }
      button { padding: 10px 14px; border: 0; border-radius: 10px; cursor: pointer; }
      .row { display:flex; gap:10px; margin-top:14px; flex-wrap: wrap; }
      #hello { margin: 10px 0 4px; font-weight: 600; }
      .muted { color:#6b7280; font-size: 14px; }
    </style>
  </head>
  <body>
    <h2>MyPersonalBuyer</h2>
    <div id="hello" class="muted">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è‚Ä¶</div>

    <div class="row">
      <button id="pingBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å /api/ping</button>
      <button id="closeBtn">–ó–∞–∫—Ä—ã—Ç—å WebApp</button>
    </div>

    <pre id="log" class="muted"></pre>

    <script>
      const tg = window.Telegram?.WebApp;
      const log = (m) => document.getElementById('log').textContent = String(m ?? '');

      function setHello(text) {
        document.getElementById('hello').textContent = text;
        document.getElementById('hello').classList.remove('muted');
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
      if (tg) {
        tg.ready();
        tg.expand();
      }

      // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ initData
      (async () => {
        try {
          const init_data = tg?.initData || '';
          const r = await fetch('/api/auth', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ init_data })
          });
          const j = await r.json();
          if (j.ok) {
            const u = j.user || {};
            setHello(`–ü—Ä–∏–≤–µ—Ç, ${u.first_name || u.username || '–¥—Ä—É–≥'} üëã`);
          } else {
            setHello('–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è üòï');
            log(JSON.stringify(j, null, 2));
          }
        } catch (e) {
          setHello('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ üòï');
          log(e);
        }
      })();

      document.getElementById('pingBtn').onclick = async () => {
        const r = await fetch('/api/ping');
        const j = await r.json();
        log(JSON.stringify(j, null, 2));
      };

      document.getElementById('closeBtn').onclick = () => {
        if (tg?.close) tg.close();
      };
    </script>
  </body>
</html>
