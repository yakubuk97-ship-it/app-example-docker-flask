<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ü—Ä–æ—Ñ–∏–ª—å</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --line:#000; --muted:#6b7280; }
    html,body{margin:0;padding:0;height:100%;background:#fff;color:#111;}
    .wrap{min-height:100vh;display:flex;flex-direction:column}
    main{flex:1;padding:16px}
    .card{border:1px solid #eee;border-radius:14px;padding:16px}
    .row{display:flex;gap:12px;align-items:center}
    .avatar{width:64px;height:64px;border-radius:50%;background:#eee;flex:0 0 64px;object-fit:cover}
    nav{position:fixed;left:0;right:0;bottom:0;height:56px;background:#fff;border-top:1px solid var(--line);
        display:flex;justify-content:center;align-items:center}
    nav .btn{display:flex;flex-direction:column;align-items:center;color:#111;font-size:12px}
    nav .ico{font-size:22px;line-height:22px}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
<div class="wrap">
  <main>
    <div id="alert" class="muted" style="margin-bottom:12px"></div>

    <div class="card">
      <div class="row">
        <img id="avatar" class="avatar" src="" alt="">
        <div>
          <div id="name" style="font-weight:800;font-size:18px">‚Äî</div>
          <div id="username" class="muted">@</div>
        </div>
      </div>
    </div>
  </main>

  <nav>
    <div id="btnProfile" class="btn">
      <div class="ico">üë§</div>
      <div>–ü—Ä–æ—Ñ–∏–ª—å</div>
    </div>
  </nav>
</div>

<script>
  const tg = window.Telegram?.WebApp;
  if (tg){ tg.ready(); tg.expand(); }

  const $ = s => document.querySelector(s);

  // –ù–∞–∂–∞–ª–∏ "–ü—Ä–æ—Ñ–∏–ª—å" ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
  $('#btnProfile').onclick = () => loadProfile();

  // 1) –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ initData
  async function auth() {
    try {
      const init_data = tg?.initData || '';
      const r = await fetch('/api/auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ init_data })
      });
      const j = await r.json();
      if (!j.ok) {
        $('#alert').textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è: ' + (j.error || '');
        return null;
      }
      // —Å–æ—Ö—Ä–∞–Ω–∏–º —Ç–æ–∫–µ–Ω –¥–ª—è –∑–∞—â–∏—â—ë–Ω–Ω—ã—Ö —Ä—É—á–µ–∫
      localStorage.setItem('token', j.token);
      return j.user;
    } catch (e) {
      $('#alert').textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e;
      return null;
    }
  }

  // 2) –ü–æ–ª—É—á–∏—Ç—å /api/me —á–µ—Ä–µ–∑ Bearer —Ç–æ–∫–µ–Ω
  async function me(){
    const token = localStorage.getItem('token');
    if (!token) return null;
    const r = await fetch('/api/me', { headers: { 'Authorization': 'Bearer ' + token } });
    const j = await r.json();
    return j.ok ? j.user : null;
  }

  function fillProfile(u){
    $('#name').textContent = [u.first_name, u.last_name].filter(Boolean).join(' ') || u.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    $('#username').textContent = u.username ? ('@' + u.username) : '@';
    const av = $('#avatar');
    if (u.photo_url) av.src = u.photo_url;
    else av.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(
      `<svg xmlns='http://www.w3.org/2000/svg' width='128' height='128'>
         <rect width='100%' height='100%' fill='#f0f0f0'/>
         <circle cx='64' cy='48' r='22' fill='#d0d3d6'/>
         <rect x='22' y='78' width='84' height='30' rx='15' fill='#d0d3d6'/>
       </svg>`
    );
  }

  async function loadProfile(){
    // –ø—Ä–æ–±—É–µ–º –ø–æ —Ç–æ–∫–µ–Ω—É
    let u = await me();
    if (!u) {
      // –µ—Å–ª–∏ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞ / –∏—Å—Ç—ë–∫ ‚Äî –∞–≤—Ç–æ—Ä–∏–∑—É–µ–º—Å—è —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ initData
      u = await auth();
    }
    if (u) {
      $('#alert').textContent = '';
      fillProfile(u);
    }
  }

  // –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –≥—Ä—É–∑–∏—Ç—å
  loadProfile();
</script>
</body>
</html>
