<!-- –≥–¥–µ-—Ç–æ —Ä—è–¥–æ–º —Å —Ç–≤–æ–∏–º–∏ –ø–ª–∏—Ç–∫–∞–º–∏ –¥–æ–±–∞–≤—å –µ—â—ë –æ–¥–Ω—É -->
<div class="row" style="margin-top:16px; gap:12px; flex-wrap:wrap">
  <button id="refBtn">–ó–æ–≤–∏ –¥—Ä—É–∑–µ–π</button>
</div>

<script>
  const tg = window.Telegram?.WebApp;
  const log = (m) => document.getElementById('log')?.textContent = String(m ?? '');

  async function getRefLink() {
    const init_data = tg?.initData || '';
    const r = await fetch('/api/ref/link', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ init_data })
    });
    return r.json();
  }

  function shareInTelegram(url, text) {
    // –û—Ç–∫—Ä–æ–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π —à–∞—Ä–∏–Ω–≥ Telegram
    const share = `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`;
    if (tg?.openTelegramLink) tg.openTelegramLink(share);
    else window.open(share, '_blank');
  }

  document.getElementById('refBtn').onclick = async () => {
    try {
      const res = await getRefLink();
      if (!res.ok) {
        tg?.showAlert?.('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É: ' + (res.error || ''));
        return;
      }
      const link = res.link;
      const text = '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è! –ü–æ–ª—É—á–∏—à—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ –±–æ–Ω—É—Å—ã üëá';

      // 1) –ø–æ–ø—ã—Ç–∞–µ–º—Å—è –æ—Ç–∫—Ä—ã—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π —à–∞—Ä–∏–Ω–≥ –¢–µ–ª–µ–≥—Ä–∞–º–∞
      shareInTelegram(link, text);

      // 2) –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –ø–æ–ª–æ–∂–∏–º —Å—Å—ã–ª–∫—É –≤ –±—É—Ñ–µ—Ä (–Ω–∞ –≤—Å—è–∫–∏–π)
      try {
        await navigator.clipboard.writeText(link);
        tg?.showPopup?.({ title: '–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞', message: link, buttons: [{type:'close'}] });
      } catch (_) {}
    } catch (e) {
      tg?.showAlert?.('–û—à–∏–±–∫–∞: ' + e.message);
    }
  };

  // (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–æ–æ–±—â–∏–º —Å–µ—Ä–≤–µ—Ä—É, –µ—Å–ª–∏ –ø—Ä–∏—à–ª–∏ –ø–æ —Ä–µ—Ñ-–∫–æ–¥—É
  (async () => {
    try {
      const init_data = tg?.initData || '';
      await fetch('/api/ref/register_visit', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ init_data })
      });
    } catch (_) {}
  })();
</script>
