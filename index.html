<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MyPersonalBuyer</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; }
      button { padding: 10px 14px; border: 0; border-radius: 10px; cursor: pointer; }
      .row { display:flex; gap:10px; margin-top:14px; flex-wrap: wrap; }
      #hello { margin: 10px 0 4px; font-weight: 600; }
      .muted { color:#6b7280; font-size: 14px; }
      .ok { color:#16a34a; }
      .err { color:#dc2626; }
      pre { white-space: pre-wrap; word-break: break-word; }
    </style>
  </head>
  <body>
    <h2>MyPersonalBuyer</h2>
    <div id="hello" class="muted">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è‚Ä¶</div>
    <div id="initlen" class="muted"></div>

    <div class="row">
      <button id="pingBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å /api/ping</button>
      <button id="orderBtn">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–±–Ω—ã–π –∑–∞–∫–∞–∑</button>
      <button id="closeBtn">–ó–∞–∫—Ä—ã—Ç—å WebApp</button>
    </div>

    <pre id="log" class="muted"></pre>

    <script>
      const tg = window.Telegram?.WebApp;
      const $ = (id) => document.getElementById(id);
      const log = (m) => $('log').textContent = typeof m === 'string' ? m : JSON.stringify(m, null, 2);
      const setHello = (text, cls='') => { const el=$('hello'); el.textContent=text; el.className = cls || ''; };

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
      if (tg) {
        tg.ready();
        tg.expand();
        // –ö–Ω–æ–ø–∫–∞ ¬´–ì–ª–∞–≤–Ω–∞—è¬ª –≤–Ω–∏–∑—É
        tg.MainButton.setText('–ì–ª–∞–≤–Ω–∞—è');
        tg.MainButton.onClick(() => {
          // —Ç—É—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ ¬´–ì–ª–∞–≤–Ω–∞—è¬ª: —Å–µ–π—á–∞—Å –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–∏–Ω–∏-–∞–ø–ø
          tg.close();
        });
        tg.MainButton.show();
      }

      // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ initData
      (async () => {
        try {
          const init_data = tg?.initData || '';
          $('initlen').textContent = `initData length: ${init_data.length}`;
          if (!init_data) {
            setHello('–û—Ç–∫—Ä–æ–π –º–∏–Ω–∏-–∞–ø–ø –∏–∑ Telegram-–±–æ—Ç–∞, –∏–Ω–∞—á–µ initData –ø—É—Å—Ç–æ–π.', 'err');
            return;
          }

          const r = await fetch('/api/auth', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ init_data })
          });
          const j = await r.json();

          if (j.ok) {
            const u = j.user || {};
            setHello(`–ü—Ä–∏–≤–µ—Ç, ${u.first_name || u.username || '–¥—Ä—É–≥'} üëã`, 'ok');
            log('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞');
          } else {
            setHello('–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è üòï', 'err');
            log(j);
          }
        } catch (e) {
          setHello('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ üòï', 'err');
          log(String(e));
        }
      })();

      // /api/ping
      $('pingBtn').onclick = async () => {
        try {
          const r = await fetch('/api/ping');
          const j = await r.json();
          log(j);
        } catch (e) {
          log(String(e));
        }
      };

      // –ü—Ä–∏–º–µ—Ä –ø—Ä–æ–±–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ –Ω–∞ /api/order
      $('orderBtn').onclick = async () => {
        try {
          // –õ—é–±–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π payload ‚Äî –Ω–∞ –±—ç–∫–µ —Å–≤—è–∂–µ–º –µ–≥–æ —Å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º user
          const payload = { items: [{ sku: 'DEMO-1', qty: 1 }], note: '–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–∫–∞–∑' };
          const r = await fetch('/api/order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const j = await r.json();
          log(j);
        } catch (e) {
          log(String(e));
        }
      };

      $('closeBtn').onclick = () => tg?.close && tg.close();
    </script>
  </body>
</html>
