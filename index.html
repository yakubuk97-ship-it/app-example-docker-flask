<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ü—Ä–æ—Ñ–∏–ª—å</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{ --bg:#fff; --text:#111317; --line:#000; }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .page{min-height:100dvh;display:flex;flex-direction:column}
    .content{flex:1;max-width:560px;margin:0 auto;width:100%;padding:16px}
    .card{border:1px solid #eee;border-radius:16px;padding:16px;display:flex;gap:12px;align-items:center}
    .avatar{width:64px;height:64px;border-radius:50%;background:#f0f0f0;object-fit:cover}
    .name{font-weight:800;font-size:18px}
    .username{color:#667085;margin-top:4px}
    nav{position:fixed;left:0;right:0;bottom:0;height:70px;background:#fff;border-top:1px solid var(--line);display:flex;justify-content:center;align-items:center}
    .nav-btn{display:flex;flex-direction:column;align-items:center;gap:6px}
    .ico{font-size:22px;line-height:22px}
    .label{font-size:14px}
    .center{display:grid;place-items:center;height:100%}
    .muted{color:#667085}
    .btn{border:1px solid #e5e7eb;border-radius:12px;padding:10px 14px;cursor:pointer}
  </style>
</head>
<body>
<div class="page">
  <main class="content">
    <div id="placeholder" class="center muted" style="height:30dvh">–ù–∞–∂–º–∏ ‚Äú–ü—Ä–æ—Ñ–∏–ª—å‚Äù –≤–Ω–∏–∑—É</div>

    <div id="card" class="card" style="display:none">
      <img id="avatar" class="avatar" alt="">
      <div>
        <div id="name" class="name">‚Äî</div>
        <div id="username" class="username">@</div>
      </div>
    </div>

    <div id="error" class="muted" style="margin-top:12px;display:none"></div>
  </main>

  <nav>
    <button id="btnProfile" class="nav-btn btn" style="border:0;background:transparent">
      <div class="ico">üë§</div>
      <div class="label">–ü—Ä–æ—Ñ–∏–ª—å</div>
    </button>
  </nav>
</div>

<script>
  const tg = window.Telegram?.WebApp;
  tg?.ready?.(); tg?.expand?.();

  const $ = s => document.querySelector(s);

  $('#btnProfile').onclick = async () => {
    $('#error').style.display = 'none';
    $('#placeholder').style.display = 'none';

    try {
      const init_data = tg?.initData || '';
      console.log('initData:', init_data); // –º–æ–∂–Ω–æ –ø–æ–¥—Å–º–æ—Ç—Ä–µ—Ç—å –≤ –∫–æ–Ω—Å–æ–ª—å

      const r = await fetch('/api/auth', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ init_data })
      });
      const j = await r.json();

      if (!j.ok) {
        $('#error').textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è: ' + (j.error || 'unknown');
        $('#error').style.display = 'block';
        return;
      }

      const u = j.user || {};
      $('#name').textContent = [u.first_name, u.last_name].filter(Boolean).join(' ') || u.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
      $('#username').textContent = u.username ? '@'+u.username : '';
      const av = $('#avatar');
      if (u.photo_url) av.src = u.photo_url;
      else av.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(
        `<svg xmlns='http://www.w3.org/2000/svg' width='128' height='128'>
           <rect width='100%' height='100%' fill='#f0f0f0'/>
           <circle cx='64' cy='48' r='22' fill='#d9d9d9'/>
           <rect x='28' y='78' width='72' height='26' rx='13' fill='#d9d9d9'/>
         </svg>`
      );

      $('#card').style.display = 'flex';
    } catch (e) {
      $('#error').textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
      $('#error').style.display = 'block';
      console.error(e);
    }
  };
</script>
</body>
</html>
