<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MyPersonalBuyer</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#ffffff;--text:#111827;--muted:#6b7280;--card:#f3f4f6;--primary:#2563eb;--primary-weak:#e5edff;--danger:#ef4444;--ok:#10b981;--divider:#e5e7eb;
    }
    html,body{height:100%}
    body{
      margin:0;padding:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif;
      background:var(--bg);color:var(--text);
    }
    .wrap{display:flex;flex-direction:column;min-height:100vh}
    header{
      padding:16px 18px 4px;font-weight:800;font-size:22px;
    }
    .subtitle{color:#b45309;background:#fff7ed;border:1px dashed #fdba74;border-radius:10px;padding:10px 12px;margin:6px 18px 8px}
    .content{flex:1;padding:12px 16px 100px}
    .grid{
      display:grid;grid-template-columns:1fr 1fr;gap:14px;margin:8px 0 18px;
    }
    .tile{
      background:var(--card);border-radius:18px;padding:24px 16px;font-weight:700;font-size:20px;
      display:flex;align-items:center;justify-content:center;text-align:center;min-height:120px;
    }
    .tile:active{transform:translateY(1px);opacity:.9}

    /* account */
    .tabs{display:flex;gap:10px;margin:4px 0 14px}
    .tab{
      flex:1;background:var(--card);padding:12px;border-radius:12px;text-align:center;font-weight:700;color:var(--muted);
      border:1px solid var(--card);
    }
    .tab.active{background:#eef2ff;border-color:#c7d2fe;color:#1e40af}
    .card{
      background:var(--card);border-radius:16px;padding:14px;border:1px solid var(--divider);
    }
    .row{display:flex;gap:12px;align-items:center}
    .avatar{
      width:56px;height:56px;border-radius:50%;background:#ddd;flex:0 0 56px;object-fit:cover
    }
    .muted{color:var(--muted)}
    .right-link{margin-left:auto;color:#ef4444;font-weight:700}

    /* actions */
    .actions{display:flex;gap:12px;margin:14px 0}
    .btn{
      border:0;padding:12px 16px;border-radius:12px;font-weight:700;background:var(--card);
    }
    .btn.primary{background:var(--primary);color:#fff}
    .pre{background:#0b1220;color:#d1e7ff;border-radius:12px;padding:10px;overflow:auto;font-family:ui-monospace,Menlo,monospace}

    /* bottom nav */
    .nav{
      position:fixed;left:0;right:0;bottom:0;backdrop-filter:saturate(1.2) blur(4px);
      background:rgba(255,255,255,.94);border-top:1px solid var(--divider);
      display:grid;grid-template-columns:repeat(5,1fr);gap:2px;padding:10px 8px 14px;z-index:99;
    }
    .nav-btn{display:flex;flex-direction:column;align-items:center;gap:4px;color:var(--muted);font-size:12px}
    .nav-btn.active{color:var(--primary)}
    .nav-ico{width:26px;height:26px;border-radius:9px;display:grid;place-items:center;background:transparent}
    .nav-btn.active .nav-ico{background:var(--primary-weak)}
    .ico{font-size:16px}

    @media (prefers-color-scheme:dark){
      :root{--bg:#0b0f14;--text:#e5e7eb;--muted:#9ca3af;--card:#0f1620;--primary:#60a5fa;--primary-weak:#11233f;--divider:#17212b}
      .pre{background:#0b1220;color:#cde4ff}
      .subtitle{background:#1f2937;color:#fbbf24;border-color:#f59e0b}
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>MyPersonalBuyer</header>

  <div id="authMessage" class="subtitle" style="display:none"></div>

  <main id="screen-home" class="content">
    <div class="grid">
      <div class="tile" data-route="home">–ì–ª–∞–≤–Ω–∞—è</div>
      <div class="tile" data-route="shop">–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω—ã</div>
      <div class="tile" data-route="fav">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
      <div class="tile" data-route="cart">–ö–æ—Ä–∑–∏–Ω–∞</div>
      <div class="tile" data-route="calc">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</div>
      <div class="tile" data-route="acc">–ê–∫–∫–∞—É–Ω—Ç</div>
    </div>

    <div class="actions">
      <button class="btn" id="pingBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å /api/ping</button>
      <button class="btn" id="closeBtn">–ó–∞–∫—Ä—ã—Ç—å WebApp</button>
    </div>
    <pre id="log" class="pre" style="display:none"></pre>
  </main>

  <!-- –ú–∞–≥–∞–∑–∏–Ω -->
  <main id="screen-shop" class="content" style="display:none">
    <div class="tabs">
      <div class="tab active">–í–∏—Ç—Ä–∏–Ω–∞</div>
      <div class="tab">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
      <div class="tab">–ü–æ–∏—Å–∫</div>
    </div>
    <div class="card muted">–ó–¥–µ—Å—å –±—É–¥–µ—Ç —Å–ø–∏—Å–æ–∫ –º–∞–≥–∞–∑–∏–Ω–æ–≤/—Ç–æ–≤–∞—Ä–æ–≤. (–∑–∞–≥–ª—É—à–∫–∞)</div>
  </main>

  <!-- –ò–∑–±—Ä–∞–Ω–Ω–æ–µ -->
  <main id="screen-fav" class="content" style="display:none">
    <div class="card muted">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ –ø–æ–∫–∞ –ø—É—Å—Ç–æ.</div>
  </main>

  <!-- –ö–æ—Ä–∑–∏–Ω–∞ -->
  <main id="screen-cart" class="content" style="display:none">
    <div class="card muted">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞. –î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –ú–∞–≥–∞–∑–∏–Ω–∞.</div>
  </main>

  <!-- –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä -->
  <main id="screen-calc" class="content" style="display:none">
    <div class="card">
      <div style="font-weight:700;margin-bottom:8px">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</div>
      <div class="muted" style="margin-bottom:10px">–§—É–Ω–∫—Ü–∏—è-–ø—Ä–∏–º–µ—Ä ‚Äî —Ä–∞—Å—Å—á—ë—Ç –∏—Ç–æ–≥–æ–≤–æ–π —Ü–µ–Ω—ã —Å –∫–æ–º–∏—Å—Å–∏–µ–π.</div>
      <div style="display:flex;gap:10px;align-items:center;margin-bottom:12px">
        <input id="price" type="number" placeholder="–¶–µ–Ω–∞" style="flex:1;padding:10px;border-radius:10px;border:1px solid var(--divider);background:var(--bg);color:var(--text)">
        <input id="fee" type="number" placeholder="–ö–æ–º–∏—Å—Å–∏—è, %" value="5" style="width:120px;padding:10px;border-radius:10px;border:1px solid var(--divider);background:var(--bg);color:var(--text)">
        <button class="btn primary" id="calcBtn">=</button>
      </div>
      <div id="calcOut" class="muted"></div>
    </div>
  </main>

  <!-- –ê–∫–∫–∞—É–Ω—Ç -->
  <main id="screen-acc" class="content" style="display:none">
    <div class="tabs" id="accTabs">
      <div class="tab active" data-acc="profile">–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</div>
      <div class="tab" data-acc="addresses">–ê–¥—Ä–µ—Å–∞</div>
      <div class="tab" data-acc="orders">–ó–∞–∫–∞–∑—ã</div>
    </div>

    <!-- –ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
    <section id="accProfile">
      <div class="card">
        <div class="row">
          <img id="accAvatar" class="avatar" src="" alt="">
          <div>
            <div id="accName" style="font-weight:800">–ò–º—è –§–∞–º–∏–ª–∏—è</div>
            <div id="accUsername" class="muted">@username</div>
          </div>
          <a href="#" class="right-link" id="accEdit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
        </div>
        <div style="height:10px"></div>
        <div class="muted">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
        <div id="accId" style="font-weight:700">‚Äî</div>
      </div>
    </section>

    <!-- –∞–¥—Ä–µ—Å–∞ -->
    <section id="accAddresses" style="display:none">
      <div class="card muted">–ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</div>
    </section>

    <!-- –∑–∞–∫–∞–∑—ã -->
    <section id="accOrders" style="display:none">
      <div class="card muted">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</div>
    </section>
  </main>

  <!-- –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é -->
  <nav class="nav" id="nav">
    <div class="nav-btn active" data-route="home">
      <div class="nav-ico"><span class="ico">üè†</span></div>
      <div>–ì–ª–∞–≤–Ω–∞—è</div>
    </div>
    <div class="nav-btn" data-route="shop">
      <div class="nav-ico"><span class="ico">üõçÔ∏è</span></div>
      <div>–ú–∞–≥–∞–∑–∏–Ω</div>
    </div>
    <div class="nav-btn" data-route="fav">
      <div class="nav-ico"><span class="ico">‚ù§Ô∏è</span></div>
      <div>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
    </div>
    <div class="nav-btn" data-route="cart">
      <div class="nav-ico"><span class="ico">üß∫</span></div>
      <div>–ö–æ—Ä–∑–∏–Ω–∞</div>
    </div>
    <div class="nav-btn" data-route="acc">
      <div class="nav-ico"><span class="ico">üë§</span></div>
      <div>–ê–∫–∫–∞—É–Ω—Ç</div>
    </div>
  </nav>
</div>

<script>
  // Telegram setup
  const tg = window.Telegram?.WebApp;
  if (tg){ tg.ready(); tg.expand(); }

  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  // simple router
  function show(route){
    // main screens
    ['home','shop','fav','cart','calc','acc'].forEach(r=>{
      $('#screen-'+r).style.display = (r===route)?'block':'none';
    });
    // nav state
    $$('#nav .nav-btn').forEach(b=>{
      b.classList.toggle('active', b.dataset.route===route);
    });
  }
  // tile click
  $$('.tile').forEach(t => t.addEventListener('click', ()=> show(t.dataset.route)));
  // bottom nav click
  $$('#nav .nav-btn').forEach(b => b.addEventListener('click', ()=> show(b.dataset.route)));

  // account tabs
  $$('#accTabs .tab').forEach(tab=>{
    tab.addEventListener('click', ()=>{
      $$('#accTabs .tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      const key = tab.dataset.acc; // profile | addresses | orders
      $('#accProfile').style.display = key==='profile' ? 'block' : 'none';
      $('#accAddresses').style.display = key==='addresses' ? 'block' : 'none';
      $('#accOrders').style.display = key==='orders' ? 'block' : 'none';
    });
  });

  // calc
  $('#calcBtn').onclick = ()=>{
    const base = parseFloat($('#price').value||'0');
    const fee = parseFloat($('#fee').value||'0');
    const total = base * (1 + fee/100);
    $('#calcOut').textContent = total ? `–ò—Ç–æ–≥–æ: ${total.toFixed(2)}` : '';
  };

  // ping & close
  $('#pingBtn').onclick = async ()=>{
    try{
      const r = await fetch('/api/ping'); const j = await r.json();
      $('#log').style.display='block';
      $('#log').textContent = JSON.stringify(j,null,2);
    }catch(e){
      $('#log').style.display='block';
      $('#log').textContent = String(e);
    }
  };
  $('#closeBtn').onclick = ()=> tg?.close?.();

  // auth
  (async ()=>{
    const authMsg = $('#authMessage');
    try{
      const init_data = tg?.initData || '';
      const r = await fetch('/api/auth',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({init_data})});
      const j = await r.json();

      let user = j?.user || null;
      if(j?.ok){
        // ok: hide warning
        authMsg.style.display = 'none';
      }else{
        // show non-blocking warning
        authMsg.textContent = `–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è (${j?.error || 'unknown'}) ‚Äî –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–æ—Å—Ç—É–ø–µ–Ω`;
        authMsg.style.display = 'block';
      }

      // fill account card (either from real user, or placeholders)
      $('#accName').textContent = user?.first_name || user?.username || '–í–∞—à–µ –∏–º—è';
      $('#accUsername').textContent = user?.username ? '@'+user.username : '@username';
      $('#accId').textContent = user?.id ?? '‚Äî';
      if(user?.photo_url){
        $('#accAvatar').src = user.photo_url;
      }else{
        // fallback avatar (–∏–Ω–∏—Ü–∏–∞–ª—ã)
        const initials = (user?.first_name||'A')[0];
        const svg = `data:image/svg+xml;utf8,
          <svg xmlns='http://www.w3.org/2000/svg' width='112' height='112'>
            <rect width='100%' height='100%' fill='%23e5e7eb'/>
            <text x='50%' y='54%' font-size='56' text-anchor='middle' fill='%239aa1a9' font-family='Arial' dy='.3em'>${initials}</text>
          </svg>`;
        $('#accAvatar').src = svg;
      }
    }catch(e){
      authMsg.textContent = '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ‚Äî –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–æ—Å—Ç—É–ø–µ–Ω';
      authMsg.style.display = 'block';
      console.error(e);
    }
  })();
</script>
</body>
</html>
<!-- –≥–¥–µ-—Ç–æ —Ä—è–¥–æ–º —Å —Ç–≤–æ–∏–º–∏ –ø–ª–∏—Ç–∫–∞–º–∏ –¥–æ–±–∞–≤—å –µ—â—ë –æ–¥–Ω—É -->
<div class="row" style="margin-top:16px; gap:12px; flex-wrap:wrap">
  <button id="refBtn">–ó–æ–≤–∏ –¥—Ä—É–∑–µ–π</button>
</div>

<script>
  const tg = window.Telegram?.WebApp;
  const log = (m) => document.getElementById('log')?.textContent = String(m ?? '');

  async function getRefLink() {
    const init_data = tg?.initData || '';
    const r = await fetch('/api/ref/link', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ init_data })
    });
    return r.json();
  }

  function shareInTelegram(url, text) {
    // –û—Ç–∫—Ä–æ–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π —à–∞—Ä–∏–Ω–≥ Telegram
    const share = `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`;
    if (tg?.openTelegramLink) tg.openTelegramLink(share);
    else window.open(share, '_blank');
  }

  document.getElementById('refBtn').onclick = async () => {
    try {
      const res = await getRefLink();
      if (!res.ok) {
        tg?.showAlert?.('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É: ' + (res.error || ''));
        return;
      }
      const link = res.link;
      const text = '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è! –ü–æ–ª—É—á–∏—à—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ –±–æ–Ω—É—Å—ã üëá';

      // 1) –ø–æ–ø—ã—Ç–∞–µ–º—Å—è –æ—Ç–∫—Ä—ã—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π —à–∞—Ä–∏–Ω–≥ –¢–µ–ª–µ–≥—Ä–∞–º–∞
      shareInTelegram(link, text);

      // 2) –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –ø–æ–ª–æ–∂–∏–º —Å—Å—ã–ª–∫—É –≤ –±—É—Ñ–µ—Ä (–Ω–∞ –≤—Å—è–∫–∏–π)
      try {
        await navigator.clipboard.writeText(link);
        tg?.showPopup?.({ title: '–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞', message: link, buttons: [{type:'close'}] });
      } catch (_) {}
    } catch (e) {
      tg?.showAlert?.('–û—à–∏–±–∫–∞: ' + e.message);
    }
  };

  // (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–æ–æ–±—â–∏–º —Å–µ—Ä–≤–µ—Ä—É, –µ—Å–ª–∏ –ø—Ä–∏—à–ª–∏ –ø–æ —Ä–µ—Ñ-–∫–æ–¥—É
  (async () => {
    try {
      const init_data = tg?.initData || '';
      await fetch('/api/ref/register_visit', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ init_data })
      });
    } catch (_) {}
  })();
</script>
